#!/bin/bash
set -e
set -x
source sourceme.sh

m_list=(2048 2304 2560 2816 3072 3328 3584 3840 4096 4352 4608 4864 5120 5376 5632 5888 6144 6400 6656 6912 7168 7424 7680 7936 8192 8448 8704 8960 9216 9472 9728 9984 10240 10496 10752 11008 11264 11520 11776 12032 12288 12544 12800 13056 13312 13568 13824 14080 14336 14592 14848 15104 15360 15616 15872 16128 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384 16384)
k_list=(2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048 2048  2048  2048  2048  2048  2048  2048  2048  2048  2048  2048  2048  2048  2048  2048  2048  2048  2048  2048  2048  2048  2048  2048  2048  2048  2304  2560  2816  3072  3328  3584  3840  4096  4352  4608  4864  5120  5376  5632  5888  6144  6400  6656  6912  7168  7424  7680  7936  8192  8448  8704  8960  9216  9472  9728  9984  10240 10496 10752 11008 11264 11520 11776 12032 12288 12544 12800 13056 13312 13568 13824 14080 14336 14592 14848 15104 15360 15616 15872 16128 16384)
n_list=(16384)
length=${#m_list[@]}

results_folder="result/test_gemm_systolicwise_performance/SystolicStream_NoC_512_Mesh4x4_Bigger_MNK"
mkdir -p ${results_folder}

for n_size in ${n_list[@]}; do
	for (( i = 0; i < length; i++ )); do
		#configuration
		m_size=${m_list[$i]}
		k_size=${k_list[$i]}
		echo "${m_size}-${n_size}-${k_size}"
		sed -i "15s/.*/    gemm_systolic_wise(${m_size},${n_size},${k_size},2);/" add_dramsyslib_patches/flex_cluster_sdk/test/src/test.c

		#simulation
		make iter
		timeout 43200 ./install/bin/gvsoc --target=pulp.chips.flex_cluster.flex_cluster --binary third_party/occamy/target/sim/sw/device/apps/blas/test/build/test.elf run --trace=/chip/cluster_0/redmule > ${results_folder}/MNK-${m_size}-${n_size}-${k_size}.log
	done
done